# pgvector Migration Strategy

## TL;DR

**–ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è.** –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –≥–∏–±—Ä–∏–¥–Ω–æ–º —Ä–µ–∂–∏–º–µ:
- ‚úÖ **–ù–æ–≤—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏** ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ pgvector —Ñ–æ—Ä–º–∞—Ç
- ‚úÖ **–°—Ç–∞—Ä—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏** ‚Üí –∏—Å–ø–æ–ª—å–∑—É—é—Ç Python fallback (–º–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)
- ‚úÖ **–ü–æ–∏—Å–∫** ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç pgvector –≥–¥–µ –¥–æ—Å—Ç—É–ø–µ–Ω, fallback –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

```
Total embeddings:     203,727
Migrated (pgvector):   1,000 (0.5%)
Legacy (TEXT):       202,727 (99.5%)
```

**Performance:**
- pgvector search: ~10-50ms –¥–ª—è 1k –∑–∞–ø–∏—Å–µ–π
- Python fallback: ~300ms –¥–ª—è 203k –∑–∞–ø–∏—Å–µ–π (–∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –≤ –ø–∞–º—è—Ç—å)

## –ó–∞—á–µ–º –Ω—É–∂–µ–Ω pgvector?

### –ü—Ä–æ–±–ª–µ–º—ã Python fallback:

1. **–ü–∞–º—è—Ç—å**: –ó–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –≤ RAM
   - 203k √ó 3072 float √ó 4 bytes = **~2.5 GB RAM** –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å

2. **–°–∫–æ—Ä–æ—Å—Ç—å**: O(n) —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
   - 203k –∑–∞–ø–∏—Å–µ–π ‚Üí ~300ms
   - 1M –∑–∞–ø–∏—Å–µ–π ‚Üí ~1.5s
   - 10M –∑–∞–ø–∏—Å–µ–π ‚Üí **–Ω–µ–ø—Ä–∏–≥–æ–¥–Ω–æ**

3. **–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –ö–∞–∂–¥—ã–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å = +2.5 GB RAM

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ pgvector:

1. **–ü–∞–º—è—Ç—å**: O(1) - —Ç–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ø–∞–º—è—Ç–∏
2. **–°–∫–æ—Ä–æ—Å—Ç—å**: HNSW –∏–Ω–¥–µ–∫—Å ‚Üí sub-second –¥–∞–∂–µ –¥–ª—è 10M –≤–µ–∫—Ç–æ—Ä–æ–≤
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–∏–Ω–µ–π–Ω–æ —Å —Ä–∞–∑–º–µ—Ä–æ–º –∏–Ω–¥–µ–∫—Å–∞, –Ω–µ –¥–∞–Ω–Ω—ã—Ö

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

### ‚úÖ Option 1: –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ù–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ.** –ü—Ä–æ—Å—Ç–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å:

1. **–ù–æ–≤—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ pgvector
2. –ß–µ—Ä–µ–∑ 1-2 –º–µ—Å—è—Ü–∞ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ **–∞–∫—Ç–∏–≤–Ω—ã—Ö** —Å—Ç–∞—Ç–µ–π –±—É–¥—É—Ç –≤ pgvector
3. –°—Ç–∞—Ä—ã–µ —Å—Ç–∞—Ç—å–∏ (–∫–æ—Ç–æ—Ä—ã–µ –Ω–∏–∫—Ç–æ –Ω–µ –∏—â–µ—Ç) –æ—Å—Ç–∞–Ω—É—Ç—Å—è –Ω–∞ fallback
4. **–ù—É–ª–µ–≤—ã–µ —É—Å–∏–ª–∏—è**, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ—Ç downtime
- –ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—é
- –§–æ–∫—É—Å –Ω–∞ –Ω–æ–≤–æ–º –∫–æ–Ω—Ç–µ–Ω—Ç–µ (–∫–æ—Ç–æ—Ä—ã–π —á–∞—â–µ –∏—â—É—Ç)

### üîß Option 2: –í—ã–±–æ—Ä–æ—á–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ **—á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–µ** —Å—Ç–∞—Ç—å–∏:

```sql
-- –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π
python scripts/migrate_embeddings_batch.py --since-days 30 --batch-size 100
```

**Use case:**
- –£ –≤–∞—Å –µ—Å—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- 80% –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –ø–æ—Å–ª–µ–¥–Ω–∏–º 30 –¥–Ω—è–º
- –ú–∏–≥—Ä–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ hot data

### ‚ö° Option 3: –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

–î–ª—è –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç–æ–≤ –∏–ª–∏ –µ—Å–ª–∏ Python fallback —Ä–µ–∞–ª—å–Ω–æ —Ç–æ—Ä–º–æ–∑–∏—Ç:

```bash
# 1. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ (4-5 —á–∞—Å–æ–≤ –¥–ª—è 203k)
python scripts/migrate_embeddings_batch.py --batch-size 100

# 2. –°–æ–∑–¥–∞—Ç—å HNSW –∏–Ω–¥–µ–∫—Å (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-30 –º–∏–Ω—É—Ç)
psql $PG_DSN -f infra/migrations/004_enable_pgvector_step2.sql

# 3. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —É–¥–∞–ª–∏—Ç—å TEXT –∫–æ–ª–æ–Ω–∫—É –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
ALTER TABLE article_chunks DROP COLUMN embedding;
```

**–°—Ç–æ–∏–º–æ—Å—Ç—å:**
- ~4-5 —á–∞—Å–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
- –ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î
- –ò–Ω–¥–µ–∫—Å –∑–∞–Ω–∏–º–∞–µ—Ç ~500MB-1GB –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞

**–í—ã–≥–æ–¥–∞:**
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –±—ã—Å—Ç—Ä—ã–º–∏ (10-50ms)
- –≠–∫–æ–Ω–æ–º–∏—è RAM (–Ω–µ—Ç fallback –∑–∞–≥—Ä—É–∑–∫–∏)
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –¥–æ 1M+ –≤–µ–∫—Ç–æ—Ä–æ–≤

## –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

```bash
# Test pgvector search
python scripts/test_pgvector_search.py

# Check migration progress
python -c "
from pg_client_new import PgClient
client = PgClient()
with client._cursor() as cur:
    cur.execute('SELECT COUNT(*) FROM article_chunks WHERE embedding_vector IS NOT NULL')
    migrated = cur.fetchone()[0]
    cur.execute('SELECT COUNT(*) FROM article_chunks WHERE embedding IS NOT NULL')
    total = cur.fetchone()[0]
    print(f'Progress: {migrated}/{total} ({100*migrated//total}%)')
"
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

–ö–æ–¥ —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤:

```python
# pg_client_new.py:819
def update_chunk_embedding(self, chunk_id, embedding):
    # 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ TEXT (backwards compatibility)
    cur.execute("UPDATE article_chunks SET embedding = %s WHERE id = %s", ...)

    # 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ pgvector (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
    try:
        cur.execute("UPDATE article_chunks SET embedding_vector = %s::vector WHERE id = %s", ...)
    except:
        pass  # pgvector –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ –Ω–æ–≤—ã–µ —Å—Ç–∞—Ç—å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –±—ã—Å—Ç—Ä—ã–π pgvector –ø–æ–∏—Å–∫.

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–æ–±–∞–≤—å—Ç–µ –º–µ—Ç—Ä–∏–∫—É –≤ monitoring:

```python
# –ü—Ä–æ—Ü–µ–Ω—Ç –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
pgvector_migration_percent = (
    SELECT COUNT(*) FILTER (WHERE embedding_vector IS NOT NULL) * 100.0 / COUNT(*)
    FROM article_chunks
    WHERE embedding IS NOT NULL
)
```

Alert –µ—Å–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç –ø–∞–¥–∞–µ—Ç (–æ–∑–Ω–∞—á–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ pgvector).

## FAQ

**Q: –ß—Ç–æ –±—É–¥–µ—Ç –µ—Å–ª–∏ –Ω–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å?**
A: –í—Å–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –ø—Ä–æ—Å—Ç–æ –ø–æ–∏—Å–∫ –ø–æ —Å—Ç–∞—Ä—ã–º —Å—Ç–∞—Ç—å—è–º –±—É–¥–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ (~300ms –≤–º–µ—Å—Ç–æ 10ms).

**Q: –ö–∞–∫ –¥–æ–ª–≥–æ –¥–ª–∏—Ç—Å—è –ø–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è?**
A: ~7-8 —Å–µ–∫ –Ω–∞ 100 —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ = 4-5 —á–∞—Å–æ–≤ –¥–ª—è 203k.

**Q: –ú–æ–∂–Ω–æ –ª–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ —Ñ–æ–Ω–µ?**
A: –î–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å `nohup` –∏–ª–∏ systemd timer:
```bash
nohup python scripts/migrate_embeddings_batch.py --batch-size 50 > migration.log 2>&1 &
```

**Q: –ù—É–∂–Ω–æ –ª–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É?**
A: –ù–µ—Ç, –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É. –ü–æ–∏—Å–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback.

**Q: –ß—Ç–æ –µ—Å–ª–∏ —É –º–µ–Ω—è 1M+ –≤–µ–∫—Ç–æ—Ä–æ–≤?**
A: –¢–æ–≥–¥–∞ –ø–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞**. Python fallback –Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è.

## –ò—Ç–æ–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤:** ‚úÖ **Option 1 (–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è)**

–ü—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–π—Ç–µ - —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º. –ï—Å–ª–∏ —á–µ—Ä–µ–∑ 2-3 –º–µ—Å—è—Ü–∞ –∑–∞–º–µ—Ç–∏—Ç–µ —á—Ç–æ –ø–æ–∏—Å–∫ —Ç–æ—Ä–º–æ–∑–∏—Ç, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤—ã–±–æ—Ä–æ—á–Ω—É—é –∏–ª–∏ –ø–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é.

**–î–ª—è –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º:** ‚ö° **Option 3 (–ø–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è)**

–ï—Å–ª–∏ —É –≤–∞—Å >1000 RPS –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ 1M+ –≤–µ–∫—Ç–æ—Ä–æ–≤.
