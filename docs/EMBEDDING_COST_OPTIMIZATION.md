# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

## üîç –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

### –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –º–æ–¥–µ–ª—å:
**OpenAI text-embedding-3-large**
- –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å: 3072
- –¶–µ–Ω–∞: **$0.00013 –∑–∞ 1K —Ç–æ–∫–µ–Ω–æ–≤**

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:

**–§–∞–π–ª:** `local_embedding_generator.py:23-45`

```python
async def generate_embeddings(self, texts: List[str]):
    embeddings = []

    # ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ü–æ –æ–¥–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∞ –∫–∞–∂–¥—ã–π —Ç–µ–∫—Å—Ç!
    for i, text in enumerate(texts):
        embedding = await self._generate_single_embedding(client, text)
        embeddings.append(embedding)
```

**–§–∞–π–ª:** `services/embedding_service.py:56-61`
```python
texts = [chunk.get('text', '') for chunk in chunks]  # batch_size=1500

# –í—ã–∑—ã–≤–∞–µ—Ç generate_embeddings —Å 1500 —Ç–µ–∫—Å—Ç–∞–º–∏
embeddings = await self.generator.generate_embeddings(texts)
# ‚Üí –ù–û –≤–Ω—É—Ç—Ä–∏ –¥–µ–ª–∞–µ—Ç 1500 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤!
```

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. **–ù–µ—Ç –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –±–∞—Ç—á–∏–Ω–≥–∞**

–ö–æ–¥ –¥–µ–ª–∞–µ—Ç –≤–∏–¥ —á—Ç–æ –±–∞—Ç—á–∏—Ç:
- `EmbeddingService` –ø–æ–ª—É—á–∞–µ—Ç 1500 chunks –∑–∞ —Ä–∞–∑
- –ü–µ—Ä–µ–¥–∞–µ—Ç –≤—Å–µ –≤ `generate_embeddings(texts)`
- **–ù–û:** –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª `for text in texts` ‚Üí 1500 HTTP –∑–∞–ø—Ä–æ—Å–æ–≤!

### 2. **–ú–µ–¥–ª–µ–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å**

- 1500 chunks √ó ~1 —Å–µ–∫—É–Ω–¥–∞ HTTP = **~25 –º–∏–Ω—É—Ç**
- –í–º–µ—Å—Ç–æ 1 –∑–∞–ø—Ä–æ—Å–∞ –∑–∞ ~5 —Å–µ–∫—É–Ω–¥

### 3. **Rate limits**

OpenAI –ª–∏–º–∏—Ç—ã –¥–ª—è tier 1:
- **3,500 requests/minute**
- –ü—Ä–∏ 1500 –∑–∞–ø—Ä–æ—Å–∞—Ö –∑–∞ 25 –º–∏–Ω—É—Ç = ~60 RPM (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞)
- –ù–æ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–≤–æ—Ç—É

### 4. **–°—Ç–æ–∏–º–æ—Å—Ç—å –ù–ï –º–µ–Ω—è–µ—Ç—Å—è** ‚ö†Ô∏è

–í–∞–∂–Ω–æ –ø–æ–Ω—è—Ç—å:
```
–°—Ç–æ–∏–º–æ—Å—Ç—å = –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ √ó $0.00013/1K

1 –∑–∞–ø—Ä–æ—Å √ó 1000 —Ç–æ–∫–µ–Ω–æ–≤ = $0.13
10 –∑–∞–ø—Ä–æ—Å–æ–≤ √ó 100 —Ç–æ–∫–µ–Ω–æ–≤ –∫–∞–∂–¥—ã–π = $0.13 (–¢–ê –ñ–ï –¶–ï–ù–ê!)

–ë–∞—Ç—á–∏–Ω–≥ –ù–ï —Å–Ω–∏–∂–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å OpenAI!
```

---

## üí∞ –ú–æ–∂–Ω–æ –ª–∏ –°–ù–ò–ó–ò–¢–¨ —Å—Ç–æ–∏–º–æ—Å—Ç—å?

### ‚ùå –ë–∞—Ç—á–∏–Ω–≥ –Ω–µ –ø–æ–º–æ–∂–µ—Ç

OpenAI —Å—á–∏—Ç–∞–µ—Ç –ø–æ —Ç–æ–∫–µ–Ω–∞–º, –Ω–µ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º.

### ‚úÖ –ß–¢–û –î–ï–ô–°–¢–í–ò–¢–ï–õ–¨–ù–û —Å–Ω–∏–∑–∏—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å:

#### 1. **–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å embeddinggemma**

**–¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:**
- 203,727 chunks √ó 750 tokens √ó $0.00013/1K = **$19.86** (—É–∂–µ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ)
- ~1000 –Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç–µ–π/–º–µ—Å—è—Ü = **$0.49/–º–µ—Å—è—Ü**

**–° embeddinggemma:**
- **$0.00** (–ø–æ–ª–Ω–æ—Å—Ç—å—é –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
- –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Ollama –ª–æ–∫–∞–ª—å–Ω–æ

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å: 768 –≤–º–µ—Å—Ç–æ 3072
- –ö–∞—á–µ—Å—Ç–≤–æ: –Ω–µ–º–Ω–æ–≥–æ –Ω–∏–∂–µ
- –°–∫–æ—Ä–æ—Å—Ç—å: –º–µ–¥–ª–µ–Ω–Ω–µ–µ (~2-3 —Å–µ–∫ –Ω–∞ chunk)

**–ö–æ–¥ —É–∂–µ –µ—Å—Ç—å!** –ü—Ä–æ—Å—Ç–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
```python
# local_embedding_generator.py —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ embeddinggemma
# –ü—Ä–æ—Å—Ç–æ –≥–¥–µ-—Ç–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ OpenAI
```

---

#### 2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å text-embedding-3-small**

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** $0.00002 –∑–∞ 1K —Ç–æ–∫–µ–Ω–æ–≤ (**–≤ 6.5 —Ä–∞–∑ –¥–µ—à–µ–≤–ª–µ!**)

```
–°–µ–π—á–∞—Å: 750 tokens √ó $0.00013/1K = $0.0000975 –∑–∞ chunk
Small:  750 tokens √ó $0.00002/1K = $0.000015 –∑–∞ chunk

–≠–∫–æ–Ω–æ–º–∏—è: 84% –¥–µ—à–µ–≤–ª–µ!
```

**–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å:** 1536 (–≤–º–µ—Å—Ç–æ 3072)

**–ö–∞—á–µ—Å—Ç–≤–æ:** –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∏–∂–µ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∑–∞–¥–∞—á

---

#### 3. **–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å chunks –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π**

–ù–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –¥–ª—è:
- –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏—Ö chunks (<50 —Å–ª–æ–≤)
- –î—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è chunks
- Low-quality –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (ads, boilerplate)

**–≠–∫–æ–Ω–æ–º–∏—è:** ~10-20%

---

#### 4. **–ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ö–æ–∂–∏–µ chunks**

–ï—Å–ª–∏ chunk –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π (95%+ similarity), –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ —ç–º–±–µ–¥–¥–∏–Ω–≥.

**–≠–∫–æ–Ω–æ–º–∏—è:** ~5-10% –¥–ª—è –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö —Å–∞–π—Ç–æ–≤ —Å —à–∞–±–ª–æ–Ω–∞–º–∏

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ë–∞—Ç—á–∏–Ω–≥ –¥–ª—è –°–ö–û–†–û–°–¢–ò (–Ω–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏)

**–¶–µ–ª—å:** –£—Å–∫–æ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≤ ~100 —Ä–∞–∑

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `local_embedding_generator.py`:**

```python
async def generate_embeddings(self, texts: List[str], batch_size: int = 100):
    """Generate embeddings with TRUE batching"""

    if not texts:
        return []

    embeddings = []

    # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –±–∞—Ç—á–∏ –ø–æ 100 (–ª–∏–º–∏—Ç OpenAI = 2048)
    for i in range(0, len(texts), batch_size):
        batch = texts[i:i + batch_size]

        try:
            # –û–î–ò–ù –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ–≥–æ –±–∞—Ç—á–∞
            batch_embeddings = await self._generate_batch_embeddings(batch)
            embeddings.extend(batch_embeddings)

            logger.info(f"Generated {len(embeddings)}/{len(texts)} embeddings")

        except Exception as e:
            logger.error(f"Batch failed: {e}")
            # Fallback: –ø–æ –æ–¥–Ω–æ–º—É
            for text in batch:
                emb = await self._generate_single_embedding(client, text)
                embeddings.append(emb)

    return embeddings

async def _generate_batch_embeddings(self, texts: List[str]):
    """Generate embeddings for batch via OpenAI API"""
    from openai import AsyncOpenAI

    client = AsyncOpenAI(api_key=os.getenv("OPENAI_API_KEY"))

    response = await client.embeddings.create(
        model="text-embedding-3-large",
        input=texts  # –í–µ—Å—å –±–∞—Ç—á –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º!
    )

    return [item.embedding for item in response.data]
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚ö° –°–∫–æ—Ä–æ—Å—Ç—å: 1500 chunks –∑–∞ ~30 —Å–µ–∫—É–Ω–¥ (–≤–º–µ—Å—Ç–æ 25 –º–∏–Ω—É—Ç)
- üí∏ –°—Ç–æ–∏–º–æ—Å—Ç—å: **—Ç–∞ –∂–µ** ($0.00013/1K tokens)

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ text-embedding-3-small

**–≠–∫–æ–Ω–æ–º–∏—è:** 84% —Å—Ç–æ–∏–º–æ—Å—Ç–∏

```python
# .env
EMBEDDING_MODEL=text-embedding-3-small

# –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å pgvector
ALTER TABLE article_chunks DROP COLUMN embedding_vector;
ALTER TABLE article_chunks ADD COLUMN embedding_vector vector(1536);
```

**–°—Ç–æ–∏–º–æ—Å—Ç—å:**
- –ë—ã–ª–æ: $0.49/–º–µ—Å—è—Ü
- –°—Ç–∞–Ω–µ—Ç: **$0.08/–º–µ—Å—è—Ü**

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ embeddinggemma (–ª–æ–∫–∞–ª—å–Ω–æ)

**–≠–∫–æ–Ω–æ–º–∏—è:** 100% —Å—Ç–æ–∏–º–æ—Å—Ç–∏

**–ù–∞–π—Ç–∏ –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è OpenAI:**
```bash
# –ü–æ–∏—Å–∫–∞—Ç—å –≥–¥–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ OpenAI
grep -r "text-embedding-3-large" .
grep -r "OpenAI" services/
grep -r "embeddings.create" .
```

**–ò–∑–º–µ–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å**

**–°—Ç–æ–∏–º–æ—Å—Ç—å:** **$0.00/–º–µ—Å—è—Ü**

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

| –í–∞—Ä–∏–∞–Ω—Ç | –°–∫–æ—Ä–æ—Å—Ç—å | –°—Ç–æ–∏–º–æ—Å—Ç—å/–º–µ—Å—è—Ü | –ö–∞—á–µ—Å—Ç–≤–æ | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|---------|----------|-----------------|----------|-----------|
| **–¢–µ–∫—É—â–∏–π (–±–µ–∑ –±–∞—Ç—á–∏–Ω–≥–∞)** | üê¢ –ú–µ–¥–ª–µ–Ω–Ω–æ | $0.49 | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | - |
| **–ë–∞—Ç—á–∏–Ω–≥ OpenAI** | ‚ö° –ë—ã—Å—Ç—Ä–æ | $0.49 | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –õ–µ–≥–∫–æ |
| **text-embedding-3-small** | ‚ö° –ë—ã—Å—Ç—Ä–æ | **$0.08** | ‚≠ê‚≠ê‚≠ê‚≠ê | –°—Ä–µ–¥–Ω–µ |
| **embeddinggemma (local)** | üê¢ –ú–µ–¥–ª–µ–Ω–Ω–æ | **$0.00** | ‚≠ê‚≠ê‚≠ê | –ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –≥–¥–µ OpenAI |

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

### –ö–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ (—Å–µ–π—á–∞—Å):
‚úÖ **–í–Ω–µ–¥—Ä–∏—Ç—å –±–∞—Ç—á–∏–Ω–≥** –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è (–Ω–µ —Å–Ω–∏–∂–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å, –Ω–æ —É—Å–∫–æ—Ä—è–µ—Ç –≤ ~100 —Ä–∞–∑)

### –°—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫ (–µ—Å–ª–∏ –±—é–¥–∂–µ—Ç –∫—Ä–∏—Ç–∏—á–µ–Ω):
‚úÖ **–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ text-embedding-3-small** - —ç–∫–æ–Ω–æ–º–∏—è 84%, –ø–æ—á—Ç–∏ —Ç–∞–∫–æ–µ –∂–µ –∫–∞—á–µ—Å—Ç–≤–æ

### –î–æ–ª–≥–∏–π —Å—Ä–æ–∫ (–µ—Å–ª–∏ $0.49/–º–µ—Å –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞):
‚úÖ **–û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å** - –ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ, –Ω–µ–±–æ–ª—å—à–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å

---

## üí° –ì–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥

**–ë–∞—Ç—á–∏–Ω–≥ –ù–ï —Å–Ω–∏–∑–∏—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å OpenAI API!**

–°—Ç–æ–∏–º–æ—Å—Ç—å = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ √ó —Ü–µ–Ω–∞.
–ë–∞—Ç—á–∏–Ω–≥ —Ç–æ–ª—å–∫–æ —É—Å–∫–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã.

–ß—Ç–æ–±—ã —Å–Ω–∏–∑–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å:
1. –ë–æ–ª–µ–µ –¥–µ—à–µ–≤–∞—è –º–æ–¥–µ–ª—å (3-small)
2. –õ–æ–∫–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å (embeddinggemma)
3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è chunks
4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å $0.49/–º–µ—Å—è—Ü - —ç—Ç–æ –æ—á–µ–Ω—å –º–∞–ª–æ.**
–í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ —Å—Ç–æ–∏—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å.
