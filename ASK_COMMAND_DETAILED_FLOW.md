# –ö–æ–º–∞–Ω–¥–∞ /ask - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã

**–î–∞—Ç–∞:** 2025-10-05
**–í–µ—Ä—Å–∏—è:** Phase 3 Agentic RAG
**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** Multi-agent iterative retrieval with self-correction

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±—â–∏–π –æ–±–∑–æ—Ä](#–æ–±—â–∏–π-–æ–±–∑–æ—Ä)
2. [–ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å](#–ø–æ—à–∞–≥–æ–≤—ã–π-–ø—Ä–æ—Ü–µ—Å—Å)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
4. [–î–µ—Ç–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö](#–¥–µ—Ç–∞–ª—å–Ω—ã–π-–ø–æ—Ç–æ–∫-–¥–∞–Ω–Ω—ã—Ö)
5. [–ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã](#–ø—Ä–∏–º–µ—Ä—ã-—Ä–∞–±–æ—Ç—ã)
6. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)

---

## –û–±—â–∏–π –æ–±–∑–æ—Ä

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç /ask?

–ö–æ–º–∞–Ω–¥–∞ `/ask` - —ç—Ç–æ **Agentic RAG** (Retrieval-Augmented Generation) —Å–∏—Å—Ç–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è:

- üìö **–ò—â–µ—Ç** —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (semantic + keyword search)
- ü§ñ **–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç** –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å –ø–æ–º–æ—â—å—é LLM
- üîÑ **–ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ —É–ª—É—á—à–∞–µ—Ç** –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞—É–Ω–¥–æ–≤ (depth=1/2/3)
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ–±—è** (self-correction –Ω–∞ depth=3)
- üìä **–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç** –æ—Ç–≤–µ—Ç —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –∏ –¥–∞—Ç–∞–º–∏

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Telegram:
/ask What are the key arguments for and against TikTok divestiture?

–ë–æ—Ç ‚Üí –û—Ç–≤–µ—Ç:
üß† Agentic RAG (depth=3): What are the key arguments...

**Arguments For Divestiture:**
‚Ä¢ National security concerns...
‚Ä¢ Bipartisan support...

**Arguments Against:**
‚Ä¢ First Amendment concerns...
‚Ä¢ Economic impact...

üìä Sources:
1. Trump's TikTok Deal... (Today, Oct 5)
2. Democrats' shutdown... (BBC, Oct 2)
```

---

## –ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å

### –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Telegram)

**–§–∞–π–ª:** [bot_service/advanced_bot.py:1268](bot_service/advanced_bot.py#L1268)

```python
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:
/ask What are the key arguments for TikTok divestiture? --depth=3

# Telegram bot –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É
async def handle_ask_deep_command(self, chat_id: str, user_id: str, args: List[str]):
    # 1. –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    depth = 3  # –∏–∑ --depth=3
    query = "What are the key arguments for TikTok divestiture?"

    # 2. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await self._send_message(chat_id, "üß† Agentic RAG (depth=3): What are...")

    # 3. –í—ã–∑–æ–≤ Phase3 Handler
    from services.phase3_handlers import execute_ask_command

    payload = await execute_ask_command(
        query=query,
        depth=depth,
        window="24h",
        lang="auto",
        k_final=5,
        correlation_id=f"ask-{user_id}"
    )
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –®–∞–≥–∞ 1:**
- ‚úÖ –ó–∞–ø—Ä–æ—Å —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- ‚è≠Ô∏è  –ü–µ—Ä–µ—Ö–æ–¥ –∫ Phase3Handlers

---

### –®–∞–≥ 2: Phase3 Handler –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–§–∞–π–ª:** [services/phase3_handlers.py:28](services/phase3_handlers.py#L28)

```python
class Phase3HandlerService:
    async def handle_ask_command(self, *, query: str, depth: int = 3, ...):
        # 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
        logger.info(f"[Phase3] /ask | query='{query[:50]}...' depth={depth}")

        # 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è Context Builder
        args_tokens = [
            'query="What are the key arguments..."',
            'window=24h',
            'lang=auto',
            'k=5',
            'depth=3'
        ]

        # 3. –í—ã–∑–æ–≤ Context Builder
        context, error_payload = await self._build_context(
            raw_command="/ask",
            args_tokens=args_tokens,
            correlation_id=correlation_id,
            lang="auto",
            window="24h",
            k_final=5,
            max_tokens=8000,
            budget_cents=50,
            timeout_s=30
        )

        if error_payload:
            return error_payload  # –û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

        # 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ depth –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        context["params"]["depth"] = depth

        # 5. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Orchestrator
        response_dict = await self.orchestrator.execute(context)

        # 6. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Telegram
        payload = format_for_telegram(response_dict)

        return payload
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –®–∞–≥–∞ 2:**
- ‚úÖ –ê—Ä–≥—É–º–µ–Ω—Ç—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã
- ‚è≠Ô∏è  –í—ã–∑–æ–≤ Context Builder

---

### –®–∞–≥ 3: Context Builder - –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–§–∞–π–ª:** [core/context/phase3_context_builder.py:40](core/context/phase3_context_builder.py#L40)

```python
class Phase3ContextBuilder:
    async def build_context(self, raw_input: Dict[str, Any]) -> Dict[str, Any]:
        # 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–∞
        if not raw_input.get("raw_command"):
            return self._error_response("VALIDATION_FAILED", ...)

        # 2. –ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–∞–Ω–¥—ã –∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
        command = self._normalize_command("/ask")  # ‚Üí "ask"
        parsed_args = self._parse_args(args, command)

        # 3. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ params
        params = self._build_params(parsed_args, defaults, user_lang)
        # params = {
        #     "query": "What are the key arguments...",
        #     "window": "24h",
        #     "lang": "auto",
        #     "k_final": 5,
        #     "sources": None,
        #     "flags": {"rerank_enabled": True}
        # }

        # 4. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ models (–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫ –Ω—É–∂–Ω—ã–º LLM)
        models = self._build_models(command)
        # models = {
        #     "primary": "gpt-5",
        #     "fallback": ["gpt-5-mini", "gpt-3.5-turbo"]
        # }

        # 5. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ limits (–±—é–¥–∂–µ—Ç –∏ —Ç–∞–π–º–∞—É—Ç—ã)
        limits = self._build_limits(defaults)
        # limits = {
        #     "max_tokens": 8000,
        #     "budget_cents": 50,
        #     "timeout_s": 30
        # }

        # 6. –ö–†–ò–¢–ò–ß–ù–û: Retrieval —Å auto-recovery
        retrieval, recovery_warnings = await self._perform_retrieval_with_recovery(
            params, feature_flags, correlation_id
        )

        if not retrieval["docs"]:
            return self._error_response(
                "NO_DATA",
                "No documents found for query",
                f"Retrieval returned 0 documents after auto-recovery attempts."
            )

        # 7. –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ k_final –ø–æ–¥ —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        params["k_final"] = len(retrieval["docs"])

        # 8. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ telemetry
        telemetry = {
            "correlation_id": correlation_id,
            "version": "phase3-orchestrator"
        }

        # 9. –ò—Ç–æ–≥–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        context = {
            "command": "ask",
            "params": params,
            "retrieval": retrieval,
            "graph": None,
            "memory": None,
            "models": models,
            "limits": limits,
            "telemetry": telemetry
        }

        return context
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –®–∞–≥–∞ 3:**
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ 3-5 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ (–∏–ª–∏ –æ—à–∏–±–∫–∞ NO_DATA)
- ‚è≠Ô∏è  –ü–µ—Ä–µ–¥–∞—á–∞ –≤ Orchestrator

---

### –®–∞–≥ 3.1: Retrieval —Å Auto-Recovery (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å)

**–§–∞–π–ª:** [core/context/phase3_context_builder.py:348](core/context/phase3_context_builder.py#L348)

–≠—Ç–æ **—Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å** - –ø–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º.

```python
async def _perform_retrieval_with_recovery(self, params, feature_flags, correlation_id):
    warnings = []
    window = params["window"]  # "24h"
    lang = params["lang"]      # "auto"
    sources = params["sources"]  # None
    k_final = params["k_final"]  # 5
    rerank_enabled = params["flags"]["rerank_enabled"]  # True

    # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ query
    query = self._build_retrieval_query(params)
    # query = "What are the key arguments for TikTok divestiture?"

    # === ATTEMPT 1: Normal retrieval ===
    docs = await self._retrieve_docs(
        query, window, lang, sources, k_final, rerank_enabled
    )

    if docs:
        return self._build_retrieval_dict(docs, ...), warnings

    # === AUTO-RECOVERY STARTS ===

    # STEP 1: Expand window (24h ‚Üí 3d ‚Üí 1w ‚Üí 2w ‚Üí 1m ‚Üí 3m)
    if feature_flags.get("auto_expand_window", True):
        max_attempts = 5
        attempts = 0
        while not docs and attempts < max_attempts:
            new_window = WINDOW_EXPANSION.get(window, window)
            if new_window == window:
                break  # Cannot expand further

            window = new_window
            attempts += 1
            warnings.append(f"expanded window to {window}")

            docs = await self._retrieve_docs(query, window, ...)

            if docs:
                return self._build_retrieval_dict(docs, ...), warnings

    # STEP 2: Relax filters (lang ‚Üí auto, sources ‚Üí None)
    if feature_flags.get("relax_filters_on_empty", True):
        lang = "auto"
        sources = None
        warnings.append("relaxed lang to auto, removed source filters")

        docs = await self._retrieve_docs(query, window, ...)

        if docs:
            return self._build_retrieval_dict(docs, ...), warnings

    # STEP 3: Disable rerank and increase k_final
    if feature_flags.get("fallback_rerank_false_on_empty", True):
        rerank_enabled = False
        k_final = 10
        warnings.append("disabled rerank, increased k_final to 10")

        docs = await self._retrieve_docs(query, window, ...)

        if docs:
            return self._build_retrieval_dict(docs, ...), warnings

    # === ALL RECOVERY ATTEMPTS FAILED ===
    return self._build_retrieval_dict([], ...), warnings
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç Auto-Recovery:**
- ‚úÖ –ü–æ–ø—ã—Ç–∫–∞ 1: –û–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫ (24h window)
- ‚è≠Ô∏è  –ü–æ–ø—ã—Ç–∫–∞ 2-6: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –æ–∫–Ω–∞ (3d, 1w, 2w, 1m, 3m)
- ‚è≠Ô∏è  –ü–æ–ø—ã—Ç–∫–∞ 7: –†–µ–ª–∞–∫—Å–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
- ‚è≠Ô∏è  –ü–æ–ø—ã—Ç–∫–∞ 8: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ rerank
- ‚ùå –ï—Å–ª–∏ –≤—Å–µ failed ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞

---

### –®–∞–≥ 3.2: _retrieve_docs - –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –≤ –ë–î

**–§–∞–π–ª:** [core/context/phase3_context_builder.py:455](core/context/phase3_context_builder.py#L455)

```python
async def _retrieve_docs(self, query: str, window: str, lang: str, ...):
    try:
        # 1. –í—ã–∑–æ–≤ RetrievalClient
        docs = await self.retrieval_client.retrieve(
            query=query,
            window=window,
            lang=lang,
            sources=sources,
            k_final=k_final,
            use_rerank=rerank_enabled
        )

        # 2. –û—á–∏—Å—Ç–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        cleaned_docs = []
        for doc in docs:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ required fields
            if not doc.get("title"):
                continue

            # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è date
            date = doc.get("date")
            if not date or not self._is_valid_date(date):
                date = datetime.utcnow().strftime("%Y-%m-%d")

            # Trim snippet
            snippet = doc.get("snippet", "")[:240]

            cleaned_docs.append({
                "article_id": doc.get("article_id"),
                "title": doc.get("title", ""),
                "url": doc.get("url"),
                "date": date,
                "lang": doc_lang,
                "score": doc.get("score", 0.0),
                "snippet": snippet
            })

        return cleaned_docs

    except Exception as e:
        logger.error(f"Retrieval failed: {e}")
        return []
```

**–í–Ω—É—Ç—Ä–∏ retrieval_client.retrieve():**

**–§–∞–π–ª:** [core/rag/retrieval_client.py:76](core/rag/retrieval_client.py#L76)

```python
async def retrieve(self, query, window, lang, sources, k_final, use_rerank):
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
    cache_key = self._build_cache_key(query, window, ...)
    cached = self._get_from_cache(cache_key)
    if cached:
        return cached

    # 2. –ü–æ–ª—É—á–µ–Ω–∏–µ RankingAPI
    api = self._get_ranking_api()

    # 3. –í—ã–∑–æ–≤ ranking_api.retrieve_for_analysis()
    results = await api.retrieve_for_analysis(
        query=query,
        window=window,
        lang=lang,
        sources=sources,
        k_final=k_final,
        use_rerank=use_rerank
    )

    # 4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
    if results:
        self._set_cache(cache_key, results)

    return results
```

**–í–Ω—É—Ç—Ä–∏ ranking_api.retrieve_for_analysis():**

**–§–∞–π–ª:** [ranking_api.py:367](ranking_api.py#L367)

```python
async def retrieve_for_analysis(self, query, window, lang, sources, k_final, use_rerank):
    # 1. –ü–∞—Ä—Å–∏–Ω–≥ time window
    window_hours = {"24h": 24, "3d": 72, "1w": 168, ...}.get(window, 24)

    # 2. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ filters
    filters = {}
    if sources:
        filters['sources'] = sources
    if lang and lang != 'auto':
        filters['lang'] = lang

    # 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è query embedding
    query_normalized = self._normalize_query(query)
    query_embeddings = await self.embedding_generator.generate_embeddings([query_normalized])

    if not query_embeddings or not query_embeddings[0]:
        logger.warning("Failed to generate query embedding")
        return []

    query_embedding = query_embeddings[0]

    # 4. Hybrid search (semantic + FTS)
    results = await self.db.search_with_time_filter(
        query=query_normalized,
        query_embedding=query_embedding,
        hours=window_hours,
        limit=k_final * 2,  # Get more candidates
        filters=filters
    )

    # 5. Scoring
    if results:
        scored_results = self.scorer.score_and_rank(results, query)

        # 6. Deduplication (FIXED LSH)
        if len(scored_results) > 1:
            deduplicated = self.dedup_engine.canonicalize_articles(scored_results)
        else:
            deduplicated = scored_results

        # 7. Return top k_final
        return deduplicated[:k_final]

    return []
```

**–í–Ω—É—Ç—Ä–∏ db.search_with_time_filter():**

**–§–∞–π–ª:** [database/production_db_client.py:622](database/production_db_client.py#L622)

```python
async def search_with_time_filter(self, query, query_embedding, hours, limit, filters):
    # 1. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è embedding –≤ pgvector —Ñ–æ—Ä–º–∞—Ç
    vector_str = '[' + ','.join(str(x) for x in query_embedding) + ']'

    # 2. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ WHERE clauses
    where_clauses = ["ac.embedding_vector IS NOT NULL"]
    where_clauses.append("ac.published_at >= NOW() - (%s || ' hours')::interval")
    params = [vector_str, hours]

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ source filter
    if filters and filters.get('sources'):
        placeholders = ','.join(['%s'] * len(filters['sources']))
        where_clauses.append(f"ac.source_domain IN ({placeholders})")
        params.extend(filters['sources'])

    where_sql = " AND ".join(where_clauses)

    # 3. SQL –∑–∞–ø—Ä–æ—Å —Å pgvector –∫–æ—Å–∏–Ω—É—Å–Ω—ã–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º
    query_sql = f"""
        SELECT
            ac.id, ac.article_id, ac.chunk_index, ac.text,
            ac.url, ac.title_norm, ac.source_domain, ac.published_at,
            1 - (ac.embedding_vector <=> %s::vector) AS similarity
        FROM article_chunks ac
        WHERE {where_sql}
        ORDER BY ac.embedding_vector <=> %s::vector
        LIMIT %s
    """

    params.extend([vector_str, limit])

    # 4. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
    cur.execute(query_sql, params)

    # 5. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    results = []
    for row in cur.fetchall():
        results.append({
            'id': row[0],
            'article_id': row[1],
            'text': row[3],
            'url': row[4],
            'title_norm': row[5],
            'source_domain': row[6],
            'published_at': str(row[7]),
            'similarity': float(row[8]),
            'semantic_score': float(row[8]),
            'fts_score': 0.5
        })

    return results
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞ –≤ –ë–î:**
```python
[
    {
        'article_id': 32807,
        'title_norm': "Government Shutdown Enters 5th Day...",
        'text': "Trump's TikTok Deal Gives Control of Platform...",
        'url': "https://www.today.com/video/...",
        'published_at': "2025-10-05 12:42:36+00:00",
        'similarity': 0.581,
        'semantic_score': 0.581,
        'fts_score': 0.5
    },
    {
        'article_id': 32717,
        'title_norm': "Americast - Will the Democrats' shutdown gamble...",
        'text': "Donald Trump has reached a deal to transfer TikTok...",
        'url': "https://www.bbc.co.uk/sounds/play/...",
        'published_at': "2025-10-02 18:15:00+00:00",
        'similarity': 0.603,
        ...
    },
    {
        'article_id': 30440,
        'title_norm': "Is TikTok about to go full Maga? ‚Äì podcast...",
        'text': "Emily Baker-White on the deal to transfer TikTok's US operations...",
        'url': "https://www.theguardian.com/news/audio/...",
        'published_at': "2025-10-03 02:00:21+00:00",
        'similarity': 0.569,
        ...
    }
]
```

---

### –®–∞–≥ 4: Phase3 Orchestrator - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

**–§–∞–π–ª:** [core/orchestrator/phase3_orchestrator_new.py:70](core/orchestrator/phase3_orchestrator_new.py#L70)

```python
class Phase3Orchestrator:
    async def execute(self, context: Dict[str, Any]) -> Dict[str, Any]:
        command = context.get("command", "")
        correlation_id = context.get("telemetry", {}).get("correlation_id")

        logger.info(f"[{correlation_id}] Executing Phase 3 command: {command}")

        try:
            # 1. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã
            if command.startswith("/ask"):
                response = await self._handle_agentic(context)
            elif command.startswith("/events"):
                response = await self._handle_events(context)
            elif command.startswith("/graph"):
                response = await self._handle_graph(context)
            ...

            # 2. –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è evidence (PII masking, domain checks)
            if hasattr(response, 'evidence'):
                response.evidence = PIIMasker.sanitize_evidence(response.evidence)

            # 3. –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ policy layer
            self.validator.validate_response(response)

            logger.info(f"[{correlation_id}] Command completed successfully")
            return response.model_dump()

        except Exception as e:
            logger.error(f"[{correlation_id}] Command failed: {e}")
            return self._build_error_response(str(e), context)
```

---

### –®–∞–≥ 4.1: Agentic RAG Agent - –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑

**–§–∞–π–ª:** [core/orchestrator/phase3_orchestrator_new.py:120](core/orchestrator/phase3_orchestrator_new.py#L120)

```python
async def _handle_agentic(self, context: Dict[str, Any]):
    # 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    docs = context.get("retrieval", {}).get("docs", [])
    params = context.get("params", {})
    query = params.get("query") or "primary question"
    lang = params.get("lang", "en")
    window = context.get("retrieval", {}).get("window", "24h")

    # 2. –°–æ–∑–¥–∞–Ω–∏–µ budget manager
    limits = context.get("limits", {})
    budget = create_budget_manager(
        max_tokens=limits.get("max_tokens", 8000),
        budget_cents=limits.get("budget_cents", 50),
        timeout_s=limits.get("timeout_s", 30)
    )

    # 3. Degradation –µ—Å–ª–∏ –±—é–¥–∂–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω
    depth = params.get("depth", 3)
    if budget.should_degrade():
        degraded = budget.get_degraded_params("/ask", {"depth": depth})
        depth = degraded.get("depth", 1)

    # 4. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Agentic RAG
    agentic_result, all_docs = await self.agentic_rag_agent.execute(
        query=query,
        initial_docs=docs,
        depth=depth,
        retrieval_fn=self._create_retrieval_fn(window, lang),
        budget_manager=budget,
        lang=lang,
        window=window
    )

    # 5. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
    insights = [
        Insight(
            text=agentic_result.answer,
            confidence=agentic_result.confidence,
            rationale=agentic_result.reasoning,
            strength="high" if agentic_result.confidence > 0.8 else "medium"
        )
    ]

    # 6. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ evidence –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    evidence = self._build_evidence_from_docs(all_docs)

    # 7. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ response
    return build_base_response(
        command="ask",
        insights=insights,
        evidence=evidence,
        lang=lang,
        meta=Meta(
            query=query,
            window=window,
            total_docs=len(all_docs),
            retrieval_depth=depth,
            model_used=agentic_result.model_used,
            correlation_id=context.get("telemetry", {}).get("correlation_id")
        )
    )
```

**–í–Ω—É—Ç—Ä–∏ agentic_rag_agent.execute():**

**–§–∞–π–ª:** [core/agents/agentic_rag.py](core/agents/agentic_rag.py)

```python
async def execute(self, query, initial_docs, depth, retrieval_fn, budget_manager, lang, window):
    iterations = []
    current_docs = initial_docs
    all_docs = list(initial_docs)

    # === ITERATION 1 ===
    answer_1, reasoning_1, needs_more_1 = await self._analyze_and_answer(
        query=query,
        docs=current_docs,
        iteration=1,
        budget_manager=budget_manager,
        lang=lang
    )

    iterations.append({
        "iteration": 1,
        "answer": answer_1,
        "reasoning": reasoning_1,
        "needs_more_info": needs_more_1,
        "docs_used": len(current_docs)
    })

    if depth == 1:
        # Quick answer mode
        return self._build_result(answer_1, reasoning_1, iterations, all_docs)

    # === ITERATION 2 ===
    if needs_more_1:
        # –ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
        refined_query = await self._refine_query(query, answer_1, reasoning_1)
        new_docs = await retrieval_fn(refined_query, k=3)

        # –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏
        current_docs = self._merge_docs(current_docs, new_docs)
        all_docs.extend(new_docs)

    answer_2, reasoning_2, needs_more_2 = await self._analyze_and_answer(
        query=query,
        docs=current_docs,
        iteration=2,
        budget_manager=budget_manager,
        lang=lang
    )

    iterations.append({
        "iteration": 2,
        "answer": answer_2,
        "reasoning": reasoning_2,
        "needs_more_info": needs_more_2,
        "docs_used": len(current_docs)
    })

    if depth == 2:
        # Standard mode
        return self._build_result(answer_2, reasoning_2, iterations, all_docs)

    # === ITERATION 3 (Self-correction) ===
    if needs_more_2:
        refined_query = await self._refine_query(query, answer_2, reasoning_2)
        new_docs = await retrieval_fn(refined_query, k=2)
        current_docs = self._merge_docs(current_docs, new_docs)
        all_docs.extend(new_docs)

    # Self-check: Compare iterations 1 and 2
    consistency_check = await self._check_consistency(answer_1, answer_2)

    if not consistency_check.is_consistent:
        # Re-analyze with all accumulated evidence
        answer_3, reasoning_3, _ = await self._analyze_and_answer(
            query=query,
            docs=current_docs,
            iteration=3,
            budget_manager=budget_manager,
            lang=lang,
            previous_answers=[answer_1, answer_2],
            consistency_issues=consistency_check.issues
        )
    else:
        answer_3 = answer_2
        reasoning_3 = reasoning_2 + " (Consistent with previous iteration)"

    iterations.append({
        "iteration": 3,
        "answer": answer_3,
        "reasoning": reasoning_3,
        "self_corrected": not consistency_check.is_consistent,
        "docs_used": len(current_docs)
    })

    # Deep mode - final answer
    return self._build_result(answer_3, reasoning_3, iterations, all_docs)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç Agentic RAG:**
```python
{
    "answer": "**Arguments For TikTok Divestiture:**\n‚Ä¢ National security concerns...\n\n**Arguments Against:**\n‚Ä¢ First Amendment concerns...",
    "reasoning": "Based on analysis of 5 recent articles...",
    "confidence": 0.85,
    "iterations": [
        {"iteration": 1, "answer": "...", "docs_used": 3},
        {"iteration": 2, "answer": "...", "docs_used": 5},
        {"iteration": 3, "answer": "...", "docs_used": 5, "self_corrected": False}
    ],
    "model_used": "gpt-5",
    "all_docs": [...]
}
```

---

### –®–∞–≥ 5: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Telegram

**–§–∞–π–ª:** [core/ux/formatter.py](core/ux/formatter.py)

```python
def format_for_telegram(response_dict: Dict[str, Any]) -> Dict[str, Any]:
    # 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    command = response_dict.get("command", "")
    insights = response_dict.get("insights", [])
    evidence = response_dict.get("evidence", [])
    meta = response_dict.get("meta", {})

    # 2. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
    if command == "ask":
        text = "üß† **Agentic RAG Result**\n\n"

        # Main answer
        if insights:
            text += insights[0].get("text", "")
            text += "\n\n"

        # Sources
        if evidence:
            text += "üìä **Sources:**\n"
            for i, ev in enumerate(evidence[:5], 1):
                title = ev.get("title", "")[:70]
                date = ev.get("date", "")
                url = ev.get("url", "")
                text += f"{i}. [{title}]({url})\n"
                text += f"   {date}\n"

        # Meta info
        if meta:
            text += f"\nüîç Window: {meta.get('window', 'N/A')} | "
            text += f"Docs: {meta.get('total_docs', 0)} | "
            text += f"Depth: {meta.get('retrieval_depth', 1)}"

    return {
        "text": text,
        "buttons": None,
        "parse_mode": "Markdown"
    }
```

---

### –®–∞–≥ 6: –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–§–∞–π–ª:** [bot_service/advanced_bot.py:1315](bot_service/advanced_bot.py#L1315)

```python
# –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è payload
return await self._send_orchestrator_payload(chat_id, payload)

# _send_orchestrator_payload:
async def _send_orchestrator_payload(self, chat_id: str, payload: Dict[str, Any]):
    text = payload.get("text", "No response")
    buttons = payload.get("buttons")
    parse_mode = payload.get("parse_mode", "Markdown")

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
    if buttons:
        await self._send_message_with_buttons(chat_id, text, buttons, parse_mode)
    else:
        await self._send_message(chat_id, text, parse_mode=parse_mode)

    return True
```

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç:**

```
üß† Agentic RAG Result

**Arguments For TikTok Divestiture:**
‚Ä¢ National security concerns about Chinese government access to US user data
‚Ä¢ Bipartisan Congressional support for restrictions
‚Ä¢ Trump administration deal to transfer control to US media moguls

**Arguments Against:**
‚Ä¢ First Amendment concerns about government ban on social media platform
‚Ä¢ Economic impact on millions of content creators and businesses
‚Ä¢ Questions about effectiveness if Chinese algorithm remains

üìä Sources:
1. [Trump's TikTok Deal Gives Control of Platform to Media Moguls](https://www.today.com/video/...)
   2025-10-05
2. [Americast - Will the Democrats' shutdown gamble pay off?](https://www.bbc.co.uk/sounds/...)
   2025-10-02
3. [Is TikTok about to go full Maga? ‚Äì podcast](https://www.theguardian.com/news/audio/...)
   2025-10-03

üîç Window: 24h | Docs: 5 | Depth: 3
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### –í–∏–∑—É–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                          TELEGRAM                               ‚îÇ
‚îÇ                     User: /ask TikTok?                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    AdvancedRSSBot                               ‚îÇ
‚îÇ           [bot_service/advanced_bot.py]                         ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚Ä¢ Parse command and arguments                                  ‚îÇ
‚îÇ  ‚Ä¢ Send "üß† Processing..." notification                         ‚îÇ
‚îÇ  ‚Ä¢ Call Phase3Handlers                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Phase3HandlerService                           ‚îÇ
‚îÇ           [services/phase3_handlers.py]                         ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚Ä¢ Prepare args tokens                                          ‚îÇ
‚îÇ  ‚Ä¢ Call Phase3ContextBuilder                                    ‚îÇ
‚îÇ  ‚Ä¢ Add depth parameter                                          ‚îÇ
‚îÇ  ‚Ä¢ Execute via Orchestrator                                     ‚îÇ
‚îÇ  ‚Ä¢ Format response for Telegram                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                Phase3ContextBuilder                             ‚îÇ
‚îÇ      [core/context/phase3_context_builder.py]                  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  Step 1: Validate & parse command                               ‚îÇ
‚îÇ  Step 2: Build params (query, window, lang, k_final)            ‚îÇ
‚îÇ  Step 3: Build models routing (gpt-5, fallbacks)               ‚îÇ
‚îÇ  Step 4: Build limits (tokens, budget, timeout)                 ‚îÇ
‚îÇ  Step 5: *** RETRIEVAL WITH AUTO-RECOVERY ***                   ‚îÇ
‚îÇ     ‚îú‚îÄ Normal retrieval (24h)                                   ‚îÇ
‚îÇ     ‚îú‚îÄ Expand window (3d, 1w, 2w, 1m, 3m)                       ‚îÇ
‚îÇ     ‚îú‚îÄ Relax filters (lang=auto, sources=None)                  ‚îÇ
‚îÇ     ‚îî‚îÄ Disable rerank, increase k                               ‚îÇ
‚îÇ  Step 6: Validate docs found                                    ‚îÇ
‚îÇ  Step 7: Build final context                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    RetrievalClient                              ‚îÇ
‚îÇ            [core/rag/retrieval_client.py]                      ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚Ä¢ Check cache                                                  ‚îÇ
‚îÇ  ‚Ä¢ Call RankingAPI.retrieve_for_analysis()                      ‚îÇ
‚îÇ  ‚Ä¢ Cache results                                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      RankingAPI                                 ‚îÇ
‚îÇ                 [ranking_api.py]                                ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  Step 1: Parse time window (24h ‚Üí 24 hours)                     ‚îÇ
‚îÇ  Step 2: Build filters (sources, lang)                          ‚îÇ
‚îÇ  Step 3: Generate query embedding (OpenAI/Local)                ‚îÇ
‚îÇ  Step 4: Search with time filter (hybrid search)                ‚îÇ
‚îÇ  Step 5: Score and rank results                                 ‚îÇ
‚îÇ  Step 6: *** DEDUPLICATION (LSH) ***                            ‚îÇ
‚îÇ  Step 7: Return top k_final                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                ProductionDBClient                               ‚îÇ
‚îÇ        [database/production_db_client.py]                      ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  *** POSTGRESQL QUERY ***                                       ‚îÇ
‚îÇ  SELECT ... FROM article_chunks                                 ‚îÇ
‚îÇ  WHERE embedding_vector IS NOT NULL                             ‚îÇ
‚îÇ    AND published_at >= NOW() - '24 hours'::interval             ‚îÇ
‚îÇ  ORDER BY embedding_vector <=> query_vector                     ‚îÇ
‚îÇ  LIMIT 10                                                       ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  Returns: 3-5 chunks with similarity scores                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ                             ‚îÇ
      ‚Üì                             ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  pgvector   ‚îÇ            ‚îÇ embeddings   ‚îÇ
‚îÇ   Index     ‚îÇ            ‚îÇ  (3072-dim)  ‚îÇ
‚îÇ   (HNSW)    ‚îÇ            ‚îÇ   OpenAI     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Results: [
  {article_id: 32807, similarity: 0.581, text: "Trump's TikTok..."},
  {article_id: 32717, similarity: 0.603, text: "Donald Trump..."},
  {article_id: 30440, similarity: 0.569, text: "Emily Baker..."}
]
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 Phase3Orchestrator                              ‚îÇ
‚îÇ      [core/orchestrator/phase3_orchestrator_new.py]            ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚Ä¢ Route to _handle_agentic()                                   ‚îÇ
‚îÇ  ‚Ä¢ Create budget manager                                        ‚îÇ
‚îÇ  ‚Ä¢ Execute Agentic RAG Agent                                    ‚îÇ
‚îÇ  ‚Ä¢ Sanitize evidence (PII masking)                              ‚îÇ
‚îÇ  ‚Ä¢ Validate response                                            ‚îÇ
‚îÇ  ‚Ä¢ Return formatted response                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  AgenticRAGAgent                                ‚îÇ
‚îÇ              [core/agents/agentic_rag.py]                      ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ITERATION 1 (depth >= 1):                                      ‚îÇ
‚îÇ    ‚îú‚îÄ Analyze initial docs (3-5 chunks)                         ‚îÇ
‚îÇ    ‚îú‚îÄ Generate answer_1 + reasoning_1                           ‚îÇ
‚îÇ    ‚îî‚îÄ Check if needs_more_info                                  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ITERATION 2 (depth >= 2):                                      ‚îÇ
‚îÇ    ‚îú‚îÄ Refine query if needed                                    ‚îÇ
‚îÇ    ‚îú‚îÄ Retrieve additional docs (2-3 more)                       ‚îÇ
‚îÇ    ‚îú‚îÄ Analyze all docs (5-8 chunks total)                       ‚îÇ
‚îÇ    ‚îú‚îÄ Generate answer_2 + reasoning_2                           ‚îÇ
‚îÇ    ‚îî‚îÄ Check if needs_more_info                                  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ITERATION 3 (depth = 3):                                       ‚îÇ
‚îÇ    ‚îú‚îÄ Refine query if needed                                    ‚îÇ
‚îÇ    ‚îú‚îÄ Retrieve final docs if needed                             ‚îÇ
‚îÇ    ‚îú‚îÄ *** SELF-CORRECTION ***                                   ‚îÇ
‚îÇ    ‚îÇ   ‚îî‚îÄ Check consistency(answer_1, answer_2)                 ‚îÇ
‚îÇ    ‚îú‚îÄ Re-analyze if inconsistent                                ‚îÇ
‚îÇ    ‚îî‚îÄ Generate final answer_3 + reasoning_3                     ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  Return:                                                        ‚îÇ
‚îÇ    ‚Ä¢ Final answer (markdown formatted)                          ‚îÇ
‚îÇ    ‚Ä¢ Reasoning chain                                            ‚îÇ
‚îÇ    ‚Ä¢ Confidence score (0.0-1.0)                                 ‚îÇ
‚îÇ    ‚Ä¢ All documents used (5-10 chunks)                           ‚îÇ
‚îÇ    ‚Ä¢ Model used (gpt-5)                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      Formatter                                  ‚îÇ
‚îÇ              [core/ux/formatter.py]                            ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚Ä¢ Format insights (answer text)                                ‚îÇ
‚îÇ  ‚Ä¢ Format evidence (sources with dates)                         ‚îÇ
‚îÇ  ‚Ä¢ Add metadata (window, docs count, depth)                     ‚îÇ
‚îÇ  ‚Ä¢ Build Telegram payload (text + markdown)                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       TELEGRAM                                  ‚îÇ
‚îÇ                    User receives:                               ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  üß† Agentic RAG Result                                          ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  **Arguments For TikTok Divestiture:**                          ‚îÇ
‚îÇ  ‚Ä¢ National security concerns...                                ‚îÇ
‚îÇ  ‚Ä¢ Bipartisan support...                                        ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  **Arguments Against:**                                         ‚îÇ
‚îÇ  ‚Ä¢ First Amendment concerns...                                  ‚îÇ
‚îÇ  ‚Ä¢ Economic impact...                                           ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  üìä Sources:                                                    ‚îÇ
‚îÇ  1. Trump's TikTok Deal... (Oct 5)                              ‚îÇ
‚îÇ  2. Democrats' shutdown... (Oct 2)                              ‚îÇ
‚îÇ  3. TikTok full Maga?... (Oct 3)                                ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  üîç Window: 24h | Docs: 5 | Depth: 3                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –û—à–∏–±–∫–∞ 1: No documents found

**–ö–æ–≥–¥–∞:** Retrieval –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–∞–∂–µ –ø–æ—Å–ª–µ auto-recovery

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```
‚ùå Phase 3 context builder error

No documents found for query
Retrieval returned 0 documents after auto-recovery attempts.
Window=3m, lang=auto, sources=None.
Steps: expanded window to 3d, expanded window to 1w, ..., increased k_final to 10
```

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ù–µ—Ç —Å—Ç–∞—Ç–µ–π –ø–æ —Ç–µ–º–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –°–ª–∏—à–∫–æ–º —É–∑–∫–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
- –ü—Ä–æ–±–ª–µ–º—ã —Å embeddings (–Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã)
- LSH deduplication –æ—à–∏–±–∫–∞ (FIXED)

**–†–µ—à–µ–Ω–∏–µ:**
- Auto-recovery —Ä–∞—Å—à–∏—Ä—è–µ—Ç –æ–∫–Ω–æ –¥–æ 3 –º–µ—Å—è—Ü–µ–≤
- –†–µ–ª–∞–∫—Å–∏—Ä—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã (lang, sources)
- –û—Ç–∫–ª—é—á–∞–µ—Ç rerank
- –ï—Å–ª–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—É—Å—Ç–æ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç error

---

### –û—à–∏–±–∫–∞ 2: LSH duplicate key (FIXED)

**–ë—ã–ª–æ:**
```
ValueError: The given key already exists
```

**–ü—Ä–∏—á–∏–Ω–∞:** Article ID –≤—Å—Ç–∞–≤–ª—è–ª—Å—è –≤ LSH –¥–≤–∞–∂–¥—ã

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** [ASK_COMMAND_LSH_FIX.md](ASK_COMMAND_LSH_FIX.md)

---

### –û—à–∏–±–∫–∞ 3: Budget exceeded

**–ö–æ–≥–¥–∞:** LLM –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –±—é–¥–∂–µ—Ç (50 —Ü–µ–Ω—Ç–æ–≤)

**–î–µ–π—Å—Ç–≤–∏–µ:**
- Budget manager –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- depth 3 ‚Üí 2 ‚Üí 1
- –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å —É–ø—Ä–æ—â–µ–Ω–Ω—ã–º —Ä–µ–∂–∏–º–æ–º

---

### –û—à–∏–±–∫–∞ 4: Timeout

**–ö–æ–≥–¥–∞:** –û–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–≤—ã—à–∞–µ—Ç —Ç–∞–π–º–∞—É—Ç (30 —Å–µ–∫—É–Ω–¥)

**–î–µ–π—Å—Ç–≤–∏–µ:**
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç partial —Ä–µ–∑—É–ª—å—Ç–∞—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
- –ò–ª–∏ error message

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Core Files:
1. [bot_service/advanced_bot.py:1268](bot_service/advanced_bot.py#L1268) - Telegram handler
2. [services/phase3_handlers.py:28](services/phase3_handlers.py#L28) - Phase3 handler
3. [core/context/phase3_context_builder.py:40](core/context/phase3_context_builder.py#L40) - Context builder
4. [core/rag/retrieval_client.py:76](core/rag/retrieval_client.py#L76) - Retrieval client
5. [ranking_api.py:367](ranking_api.py#L367) - Ranking API
6. [database/production_db_client.py:622](database/production_db_client.py#L622) - Database client
7. [core/orchestrator/phase3_orchestrator_new.py:70](core/orchestrator/phase3_orchestrator_new.py#L70) - Orchestrator
8. [core/agents/agentic_rag.py](core/agents/agentic_rag.py) - Agentic RAG agent
9. [core/ux/formatter.py](core/ux/formatter.py) - Formatter

### Supporting Files:
10. [ranking_service/deduplication.py](ranking_service/deduplication.py) - LSH deduplication
11. [core/models/model_router.py](core/models/model_router.py) - Model routing
12. [core/models/budget_manager.py](core/models/budget_manager.py) - Budget management

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-10-05
**–ê–≤—Ç–æ—Ä:** Claude Code Agent
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready
