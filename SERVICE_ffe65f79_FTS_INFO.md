# FTS Indexing Service Documentation

**Service ID:** `ffe65f79-4dc5-4757-b772-5a99c7ea624f`

**Service Name:** FTS Indexing Service (Continuous)

**Last Updated:** 2025-10-05

---

## Overview

This Railway service maintains Full-Text Search (FTS) indexes for all articles in the PostgreSQL database using `tsvector` and `tsquery` functionality. It works in parallel with the OpenAI Embedding service to enable **hybrid search** - combining semantic similarity (vector embeddings) with traditional keyword-based full-text search.

---

## Configuration

### Environment Variables

```bash
# Service mode selector (launcher.py)
SERVICE_MODE=fts-continuous

# FTS-specific settings
FTS_CONTINUOUS_INTERVAL=60    # Seconds between index update cycles
FTS_BATCH=100000              # Maximum articles to process per batch

# Database connection (shared across all services)
PG_DSN=postgresql://user:pass@host:port/database
```

### Command Executed

```bash
python main.py services start --services fts --fts-interval 60
```

This command is generated by [launcher.py](launcher.py) based on the `SERVICE_MODE` environment variable.

---

## How It Works

### 1. Continuous Monitoring

The FTS service runs in a continuous loop:
- Checks database every **60 seconds** for articles needing FTS indexing
- Processes up to **100,000 articles per batch**
- Updates `tsvector` columns in the database

### 2. FTS Index Structure

FTS indexes are stored in PostgreSQL using the native `tsvector` type:

```sql
-- Typical FTS column structure
ALTER TABLE fulltext ADD COLUMN fts_vector tsvector;

-- Index for fast search
CREATE INDEX idx_fts_vector ON fulltext USING GIN(fts_vector);

-- Update trigger to maintain index
CREATE TRIGGER tsvector_update BEFORE INSERT OR UPDATE
ON fulltext FOR EACH ROW EXECUTE FUNCTION
tsvector_update_trigger(fts_vector, 'pg_catalog.russian', title, content);
```

### 3. Supported Languages

The FTS service typically uses PostgreSQL text search configurations:
- **Russian:** `pg_catalog.russian`
- **English:** `pg_catalog.english`
- **Multi-language:** Automatic language detection per article

### 4. Integration with Hybrid Search

The FTS service works alongside the vector embedding service:

```
User Query: "новости о технологиях"
    │
    ├─→ Semantic Search (pgvector)
    │   └─ Finds conceptually similar articles using embeddings
    │
    └─→ Full-Text Search (FTS)
        └─ Finds exact keyword matches using tsvector
            │
            ↓
        Reciprocal Rank Fusion (RRF)
        Combines both result sets with configurable weights
            │
            ↓
        Final ranked results returned to user
```

---

## Monitoring & Debugging

### Check Service Status

```bash
# Link to the FTS service
railway link --service ffe65f79-4dc5-4757-b772-5a99c7ea624f

# View real-time logs
railway logs

# Check environment variables
railway vars
```

### Check FTS Index Coverage

```python
# Create check_fts_coverage.py
from database.production_db_client import ProductionDBClient

db = ProductionDBClient()

with db._cursor() as cur:
    # Check how many articles have FTS indexes
    cur.execute("""
        SELECT
            COUNT(*) as total_articles,
            COUNT(*) FILTER (WHERE fts_vector IS NOT NULL) as indexed,
            ROUND(100.0 * COUNT(*) FILTER (WHERE fts_vector IS NOT NULL) / COUNT(*), 2) as coverage_pct
        FROM fulltext
    """)

    row = cur.fetchone()
    print(f"Total articles: {row[0]:,}")
    print(f"With FTS index: {row[1]:,}")
    print(f"Coverage: {row[2]}%")
```

### Test FTS Search

```python
# Create test_fts_search.py
from database.production_db_client import ProductionDBClient

db = ProductionDBClient()

query = "технологии искусственный интеллект"

with db._cursor() as cur:
    cur.execute("""
        SELECT
            article_id,
            title,
            ts_rank(fts_vector, to_tsquery('russian', %s)) as rank
        FROM fulltext
        WHERE fts_vector @@ to_tsquery('russian', %s)
        ORDER BY rank DESC
        LIMIT 10
    """, (query, query))

    results = cur.fetchall()
    for article_id, title, rank in results:
        print(f"[{rank:.4f}] {title[:80]}")
```

---

## Performance Metrics

### Expected Processing Rate

- **Batch size:** 100,000 articles
- **Interval:** 60 seconds
- **Indexing speed:** ~1,000-5,000 articles/second (depends on text length)
- **Resource usage:** Low CPU, moderate I/O

### Database Impact

- **Index size:** ~20-30% of fulltext table size
- **Query performance:** 10-100x faster than LIKE/ILIKE
- **Update overhead:** Minimal with triggers

---

## Architecture Integration

### Position in Pipeline

```
RSS POLL → WORK → ┬→ CHUNK → OpenAI Embeddings
                   │
                   └→ FTS Indexing (this service)
                        │
                        ↓
                   Hybrid Search Ready
```

The FTS service runs in **parallel** with the chunking/embedding pipeline:
- Processes articles immediately after WORK service completes
- Does not block semantic embedding generation
- Enables faster deployment of search functionality

---

## Related Services

| Service | ID | Purpose | Relation to FTS |
|---------|-----|---------|-----------------|
| RSS POLL | d116f94c | Ingest articles | Provides raw data |
| WORK | 4692233a | Extract fulltext | Creates articles for FTS |
| CHUNK | f32c1205 | Create chunks | Parallel processing |
| OpenAI Embed | c015bdb5 | Generate vectors | Complementary search method |

---

## Troubleshooting

### Issue: FTS index not updating

**Symptom:** New articles don't appear in FTS search

**Check:**
```bash
railway logs | grep -i "fts"
railway logs | grep -i "error"
```

**Common causes:**
- Service not running (check `railway status`)
- Database trigger disabled
- `FTS_CONTINUOUS_INTERVAL` too high

### Issue: Poor search quality

**Symptom:** Irrelevant results for queries

**Solutions:**
- Check language configuration (russian vs english)
- Adjust FTS weights for title vs content
- Consider adding custom dictionaries
- Use hybrid search with semantic embeddings

### Issue: High database load

**Symptom:** Database CPU/I/O spikes

**Solutions:**
- Reduce `FTS_BATCH` size
- Increase `FTS_CONTINUOUS_INTERVAL`
- Use partial indexes for recent articles only
- Enable GIN index fastupdate parameter

---

## Code References

### Launcher Configuration
- [launcher.py:73-79](launcher.py#L73-L79) - FTS mode detection and command building

### FTS Service Implementation
- `main.py services start --services fts` - FTS service entrypoint
- `services/fts_indexing_service.py` - FTS indexing logic (if exists)

### Database Schema
- `database/migrations/` - FTS column and index definitions
- `database/production_db_client.py` - FTS query methods

---

## Deployment Checklist

When deploying or updating the FTS service:

- [ ] Verify `SERVICE_MODE=fts-continuous` is set
- [ ] Confirm `FTS_CONTINUOUS_INTERVAL` is appropriate (60s recommended)
- [ ] Check `PG_DSN` connection string is correct
- [ ] Verify database has FTS triggers enabled
- [ ] Test with `python launcher.py` locally first
- [ ] Monitor logs after deployment for errors
- [ ] Verify FTS coverage increases over time
- [ ] Test hybrid search functionality

---

## Key Benefits

✅ **Fast keyword search** - Sub-second response for exact matches
✅ **Language-aware** - Proper stemming and stopword handling
✅ **Complements semantic search** - Best of both worlds with hybrid approach
✅ **Low maintenance** - Automatic updates via database triggers
✅ **Scalable** - GIN indexes handle millions of articles efficiently

---

## References

- [PostgreSQL Full-Text Search Documentation](https://www.postgresql.org/docs/current/textsearch.html)
- [RAILWAY_SERVICES_CONFIG.md](RAILWAY_SERVICES_CONFIG.md) - Complete service overview
- [FULL_COMMANDS_ANALYSIS.md](FULL_COMMANDS_ANALYSIS.md) - How /search uses FTS
