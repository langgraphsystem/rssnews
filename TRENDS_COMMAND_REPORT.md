# üìà –û—Ç—á–µ—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã `/trends`

## ‚úÖ –°—Ç–∞—Ç—É—Å: –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–û –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û

–ö–æ–º–∞–Ω–¥–∞ `/trends` –±—ã–ª–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞, –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã, –∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ –ø–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.

---

## üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ `get_recent_articles`**
**–ü—Ä–æ–±–ª–µ–º–∞:** –í –∫–æ–¥–µ `advanced_bot.py:1856` –≤—ã–∑—ã–≤–∞–ª—Å—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ `self.db.get_recent_articles()`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `get_recent_articles()` –≤ `ProductionDBClient`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `asyncio` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã sync –∏ async –≤–µ—Ä—Å–∏–∏ –º–µ—Ç–æ–¥–∞

```python
async def get_recent_articles(self, hours: int = 24, limit: int = 50) -> List[Dict[str, Any]]:
    """Get recent articles for analysis (async version)"""
    return await asyncio.to_thread(self._get_recent_articles_sync, hours, limit)
```

### 2. **–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–∏–ø–æ–≤ –¥–∞—Ç**
**–ü—Ä–æ–±–ª–µ–º–∞:** TrendsService –ø–∞–¥–∞–ª —Å –æ—à–∏–±–∫–æ–π `TypeError: unsupported operand type(s) for -: 'datetime.datetime' and 'str'`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –¥–∞—Ç –≤ –º–µ—Ç–æ–¥–µ `_hour_buckets()`
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ ISO —Å—Ç—Ä–æ–∫ –≤ datetime –æ–±—ä–µ–∫—Ç—ã
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤

```python
# Convert string dates to datetime objects if needed
if isinstance(dt, str):
    try:
        dt = datetime.fromisoformat(dt.replace('Z', '+00:00'))
        if dt.tzinfo:
            dt = dt.replace(tzinfo=None)
    except Exception:
        continue
```

---

## üß™ –ü—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### ‚úÖ –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- **–ò–º–ø–æ—Ä—Ç—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** ‚úÖ –ü–†–û–ô–î–ï–ù
- **TrendsService:** ‚úÖ –ü–†–û–ô–î–ï–ù
- **–ü–æ–ª–Ω—ã–π –∫–æ–Ω–≤–µ–π–µ—Ä –∫–æ–º–∞–Ω–¥—ã:** ‚úÖ –ü–†–û–ô–î–ï–ù

### ‚úÖ –¢–µ—Å—Ç 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–æ—Ç–æ–º:** ‚úÖ –ü–†–û–ô–î–ï–ù
- **–ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏:** ‚úÖ –ü–†–û–ô–î–ï–ù
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ callback:** ‚úÖ –ü–†–û–ô–î–ï–ù

### ‚úÖ –¢–µ—Å—Ç 3: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç —Å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–º–∏
- **–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢
- **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢
- **–ê–Ω–∞–ª–∏–∑ –¥–∏–Ω–∞–º–∏–∫–∏:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢
- **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Markdown:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢

---

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–∞–Ω–¥—ã `/trends`

### –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
1. **–ö–æ–º–∞–Ω–¥–∞ `/trends`** ‚Üí `AdvancedRSSBot.handle_trends_command()`
2. **–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** ‚Üí `TrendsService.build_trends()`
3. **SQL –∑–∞–ø—Ä–æ—Å** ‚Üí `_fetch_articles_with_embeddings()`
4. **–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è** ‚Üí DBSCAN —Å –∫–æ—Å–∏–Ω—É—Å–Ω—ã–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º
5. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤** ‚Üí c-TF-IDF –ø–æ–¥—Ö–æ–¥
6. **–ê–Ω–∞–ª–∏–∑ –¥–∏–Ω–∞–º–∏–∫–∏** ‚Üí –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã + –º–æ–º–µ–Ω—Ç—É–º
7. **–†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Üí –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫–æ—Ä
8. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Üí Markdown —Å —ç–º–æ–¥–∑–∏
9. **–û—Ç–ø—Ä–∞–≤–∫–∞** ‚Üí Telegram API —Å –∫–Ω–æ–ø–∫–∞–º–∏

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- **TrendsService** - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤
- **ProductionDBClient** - —Ä–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- **MessageFormatter** - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- **DBSCAN** - –∞–ª–≥–æ—Ä–∏—Ç–º –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
- **TF-IDF** - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

### –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è (DBSCAN):
- `eps=0.30` - –ø–æ—Ä–æ–≥ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
- `min_samples=5` - –º–∏–Ω–∏–º—É–º —Å—Ç–∞—Ç–µ–π –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
- `metric="cosine"` - –∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ

### –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ:
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: **24 —á–∞—Å–∞**
- –ú–∞–∫—Å–∏–º—É–º —Å—Ç–∞—Ç–µ–π: **600**
- –¢–æ–ø —Ç—Ä–µ–Ω–¥–æ–≤: **10**

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:
- TTL: **10 –º–∏–Ω—É—Ç (600 —Å–µ–∫—É–Ω–¥)**
- –ö–ª—é—á: `"trends:{window}:{limit}:{topn}"`

### –°–∫–æ—Ä–∏–Ω–≥ —Ç—Ä–µ–Ω–¥–æ–≤:
```
score = 0.5 * burst_intensity + 0.3 * momentum + 0.2 * volume
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:
```sql
SELECT ai.article_id, ai.url, ai.source, ai.domain,
       ai.title_norm, ai.clean_text, ai.published_at,
       ac.embedding
FROM articles_index ai
JOIN LATERAL (
    SELECT ac.embedding
    FROM article_chunks ac
    WHERE ac.article_id = ai.article_id
      AND ac.embedding IS NOT NULL
    ORDER BY ac.chunk_index ASC
    LIMIT 1
) ac ON TRUE
WHERE ai.published_at >= NOW() - (hours || ' hours')::interval
  AND (ai.is_canonical IS TRUE OR ai.is_canonical IS NULL)
ORDER BY ai.published_at DESC NULLS LAST
LIMIT limit
```

### –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏:
- **scikit-learn** - DBSCAN, TF-IDF
- **numpy** - —Ä–∞–±–æ—Ç–∞ —Å –º–∞—Å—Å–∏–≤–∞–º–∏
- **asyncio** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å
- **psycopg2** - PostgreSQL

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ –∫–æ–º–∞–Ω–¥—ã:
```markdown
üìà –¢—Ä–µ–Ω–¥—ã –∑–∞ 24h

1. üö® **AI breakthrough, developments** ‚Äî 24 —à—Ç, Œî +200%
   üîë artificial intelligence, breakthrough, medical diagnostics
   ‚Ä¢ AI breakthrough: Artificial intelligence makes significant progress...
     https://news00.com/article
   ‚Ä¢ AI breakthrough: Medical AI shows 95% accuracy in diagnosis...
     https://news01.com/article

2. **climate, research** ‚Äî 18 —à—Ç, Œî +150%
   üîë climate change, global warming, research findings
   ...
```

### –ö–Ω–æ–ø–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:
- üîÑ **–û–±–Ω–æ–≤–∏—Ç—å** - –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å —Ç—Ä–µ–Ω–¥—ã
- üìä **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** - –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ö–æ–º–∞–Ω–¥–∞ `/trends` **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–∞** –∏ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:

1. ‚úÖ **–í—Å–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã**
2. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –º–µ—Ç–æ–¥—ã**
3. ‚úÖ **–ü—Ä–æ–≤–µ–¥–µ–Ω–æ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
4. ‚úÖ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–æ—Ç–æ–º**
5. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤**
6. ‚úÖ **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã**

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production –æ–∫—Ä—É–∂–µ–Ω–∏–∏.**

---

*–û—Ç—á–µ—Ç —Å–æ—Å—Ç–∞–≤–ª–µ–Ω: 28 —Å–µ–Ω—Ç—è–±—Ä—è 2025–≥.*
*–°—Ç–∞—Ç—É—Å: –ì–û–¢–û–í–û –ö –ü–†–û–î–ê–ö–®–ï–ù–£ ‚úÖ*